<section class="project-banner">
  <app-breadcrumb
    [items]="[
      { label: 'Home', url: '/' },
      { label: 'Explore', url: '/explore' },
      { label: projectId, url: '' }
    ]"
  ></app-breadcrumb>

  <div
    class="banner-image"
    [ngStyle]="{
      'background-image': project()?.metadata?.banner
        ? 'url(' + project()?.metadata?.banner + ')'
        : 'none'
    }"
  ></div>
</section>

<div class="container">
  @if (!project() && indexer.loading()) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading project details...</p>
    </div>
  }

  @if (!project() && !indexer.loading()) {
    <div class="not-found-container">
      <span class="material-icons not-found-icon">search_off</span>
      <h1>Project not found... yet</h1>
      <p class="not-found-description">
        If you recently created a new Angor project, it might take a few minutes 
        for it to be distributed and indexed on the decentralized infrastructure.
      </p>
      <div class="not-found-actions">
        <button (click)="reloadPage()" class="primary-button">
          <span class="material-icons">refresh</span>
          Retry
        </button>
        <a routerLink="/explore" class="secondary-button">
          <span class="material-icons">explore</span>
          Explore All Projects
        </a>
      </div>
    </div>
  }

  @if (project()) {
    <div class="project-header">
      @if (project()?.metadata?.['picture']) {
        <img
          #projectImage
          [src]="project()?.metadata?.['picture']"
          class="project-logo"
          alt="Project logo"
          (click)="showImagePopup = true; selectedImage = project()?.metadata?.['picture'] ?? null"
          loading="eager"
        />
      }
      
      <div class="project-title-container">
        <div class="project-title-row">
          <h1>{{ project()?.metadata?.name || projectId }}</h1>
          
          <div class="project-actions">
            <button 
              [title]="isFavorite() ? 'Remove from bookmarks' : 'Add to bookmarks'"
              [class.active]="isFavorite()"
              (click)="toggleFavorite()"
              class="icon-button"
            >
              <span class="material-icons">{{ isFavorite() ? 'bookmark' : 'bookmark_border' }}</span>
            </button>
            
            <button
              [title]="'Report this project'"
              (click)="reportProject()"
              class="icon-button"
            >
              <span class="material-icons">report_problem</span>
            </button>
          </div>
        </div>
        
        <p class="project-about">{{ project()?.metadata?.about }}</p>
        
        <!-- Project status notification -->
        @if (isProjectSuccessful()) {
          <div class="project-status-notification success">
            <span class="material-icons status-icon">check_circle</span>
            <div class="status-message">
              <h3>Project Successfully Funded!</h3>
              <p>This project reached its funding goal of {{ bitcoin.toBTC(project()?.details?.targetAmount ?? 0) }} 
                {{ networkService.isMain() ? 'BTC' : 'TBTC' }} 
                ({{ getFundingPercentage() }}% funded).
              </p>
            </div>
          </div>
        }
        
        @if (isProjectFailed()) {
          <div class="project-status-notification failure">
            <span class="material-icons status-icon">error</span>
            <div class="status-message">
              <h3>Project Did Not Reach Funding Goal</h3>
              <p>This project raised {{ bitcoin.toBTC(project()?.stats?.amountInvested ?? 0) }} 
                {{ networkService.isMain() ? 'BTC' : 'TBTC' }} 
                of its {{ bitcoin.toBTC(project()?.details?.targetAmount ?? 0) }} 
                {{ networkService.isMain() ? 'BTC' : 'TBTC' }} goal 
                ({{ getFundingPercentage() }}% funded).
              </p>
            </div>
          </div>
        }
        
        <!-- External links -->
        @if (project()?.details?.nostrPubKey) { 
          <div class="external-links">
            <a
              [href]="'https://primal.net/p/' + user?.npub"
              target="_blank"
              class="external-link-button"
            >
              <span class="material-icons">launch</span>
              Primal
            </a>
            <a
              [href]="'https://notes.blockcore.net/p/' + user?.npub"
              target="_blank"
              class="external-link-button"
            >
              <span class="material-icons">launch</span>
              Notes
            </a>
            <a
              [href]="'https://njump.me/' + user?.npub"
              target="_blank"
              class="external-link-button"
            >
              <span class="material-icons">launch</span>
              njump
            </a>
          </div>
        }
        
        <!-- Social links -->
        <div class="social-links">
          @for (identity of project()?.externalIdentities; track identity.platform) {
            <a
              [href]="getSocialLink(identity)"
              target="_blank"
              class="social-link"
              [title]="identity.username"
            >
              <span class="material-icons">{{ getSocialIcon(identity.platform) }}</span>
              <span>{{ formatUsername(identity.username) }}</span>
            </a>
          }
        </div>
      </div>
      
      <!-- Desktop invest button -->
      <div class="invest-button-container desktop-only">
        <button
          class="invest-button"
          [disabled]="isProjectNotStarted()"
          [class.disabled]="isProjectNotStarted()"
          (click)="!isProjectNotStarted() && openInvestWindow()"
        >
          @if (isProjectNotStarted()) { 
            Starts {{ project()?.details?.startDate ?? 0 | ago }}
          } @else { 
            Invest Now 
          }
        </button>
      </div>
    </div>
    
    <!-- Mobile invest button -->
    <div class="invest-button-container mobile-only">
      <button
        class="invest-button"
        [disabled]="isProjectNotStarted()"
        [class.disabled]="isProjectNotStarted()"
        (click)="!isProjectNotStarted() && openInvestWindow()"
      >
        @if (isProjectNotStarted()) { 
          Starts {{ project()?.details?.startDate ?? 0 | ago }}
        } @else { 
          Invest Now 
        }
      </button>
    </div>
    
    <!-- Stats Dashboard -->
    <div class="stats-dashboard">
      <div class="stats-card funding-card" [style.--progress-percentage]="getFundingPercentage() + '%'">
        <div class="stats-icon">
          <span class="material-icons">campaign</span>
        </div>
        <div class="stats-content">
          <div class="stats-title">Total Raised</div>
          <div class="stats-value">{{ bitcoin.toBTC((project()?.stats?.amountInvested ?? 0)) }} {{ networkService.isMain() ? 'BTC' : 'TBTC' }}</div>
          <div class="stats-progress">
            <div class="stats-progress-bar"></div>
            <div class="stats-progress-label">{{ getFundingPercentage() }}% of {{ bitcoin.toBTC(project()?.details?.targetAmount ?? 0) }} {{ networkService.isMain() ? 'BTC' : 'TBTC' }}</div>
          </div>
        </div>
      </div>
      
      <div class="stats-card investors-card">
        <div class="stats-icon">
          <span class="material-icons">people</span>
        </div>
        <div class="stats-content">
          <div class="stats-title">Total Investors</div>
          <div class="stats-value">{{ project()?.stats?.investorCount }}</div>
        </div>
      </div>
      
      <div class="stats-card spent-card" [style.--progress-percentage]="getSpentPercentage() + '%'">
        <div class="stats-icon">
          <span class="material-icons">account_balance_wallet</span>
        </div>
        <div class="stats-content">
          <div class="stats-title">Founder Spent</div>
          <div class="stats-value">{{ bitcoin.toBTC((project()?.stats?.amountSpentSoFarByFounder ?? 0)) }} {{ networkService.isMain() ? 'BTC' : 'TBTC' }}</div>
          <div class="stats-progress">
            <div class="stats-progress-bar"></div>
            <div class="stats-progress-label">{{ getSpentPercentage() }}% of raised funds</div>
          </div>
        </div>
      </div>
      
      <div class="stats-card penalties-card" [style.--progress-percentage]="getPenaltiesPercentage() + '%'">
        <div class="stats-icon">
          <span class="material-icons">trending_down</span>
        </div>
        <div class="stats-content">
          <div class="stats-title">Withdrawn by Investors</div>
          <div class="stats-value">{{ bitcoin.toBTC((project()?.stats?.amountInPenalties ?? 0)) }} {{ networkService.isMain() ? 'BTC' : 'TBTC' }}</div>
          <div class="stats-progress">
            <div class="stats-progress-bar"></div>
            <div class="stats-progress-label">{{ project()?.stats?.countInPenalties }} investors ({{ getPenaltiesPercentage() }}%)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs navigation -->
    <div class="tabs-container">
      @for (tab of tabs; track tab.id) {
        <button
          class="tab-button"
          [class.active]="activeTab === tab.id"
          (click)="setActiveTab(tab.id)"
        >
          <span class="tab-icon">{{ tab.icon }}</span>
          <span class="tab-label">{{ tab.label }}</span>
        </button>
      }
    </div>
    
    <!-- Tab content -->
    <div class="tab-content">
      @if (activeTab === 'project') {
        <div class="project-grid">
          <div class="project-main-content">
            @if (project()?.content) {
              <!-- Media carousel -->
              @if (project()?.media?.length) {
                <div class="media-carousel">
                  <div class="carousel-track" [style.transform]="'translateX(' + -currentSlide * 100 + '%)'">
                    @for (item of project()?.media; track item.url) {
                      @if (item.type === 'image') {
                        <div class="carousel-slide">
                          <img
                            [src]="item.url"
                            alt="Project media"
                            loading="lazy"
                            (click)="showImagePopup = true; selectedImage = item.url"
                          />
                        </div>
                      }
                    }
                  </div>
                  
                  @if ((project()?.media?.length ?? 0) > 1) {
                    <button class="carousel-control prev" (click)="prevSlide()">
                      <span class="material-icons">chevron_left</span>
                    </button>
                    <button class="carousel-control next" (click)="nextSlide()">
                      <span class="material-icons">chevron_right</span>
                    </button>
                    
                    <div class="carousel-indicators">
                      @for (item of project()?.media; track $index) {
                        <button 
                          class="indicator-dot" 
                          [class.active]="currentSlide === $index"
                          (click)="currentSlide = $index"
                        ></button>
                      }
                    </div>
                  }
                </div>
              }
              
              <!-- Project content -->
              <div class="content-card">
                <h2>About This Project</h2>
                <markdown [data]="project()?.content" class="project-markdown"></markdown>
              </div>
              
              <!-- Project members -->
              @if (project()?.members?.length) {
                <div class="members-card">
                  <h2>Project Team</h2>
                  <div class="members-grid">
                    @for (member of project()?.members; track member) {
                      <div class="member-item">
                        <app-profile
                          class="project-member"
                          [npub]="member"
                          [link]="'https://primal.net/p/' + member"
                        ></app-profile>
                      </div>
                    }
                  </div>
                </div>
              }
            }
          </div>
          
          <!-- Project sidebar -->
          <div class="project-sidebar">
            <!-- Project Details -->
            <div class="sidebar-card">
              <h3>Project Details</h3>
              <div class="detail-item">
                <div class="detail-label">Start Date</div>
                <div class="detail-value">{{ formatDate(project()?.details?.startDate) }}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Expiry Date</div>
                <div class="detail-value">{{ formatDate(project()?.details?.expiryDate) }}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Penalty Days</div>
                <div class="detail-value">{{ project()?.details?.penaltyDays }} days</div>
              </div>
            </div>
            
            <!-- Funding Stages -->
            <div class="sidebar-card">
              <h3>Funding Stages</h3>
              <div class="stages-timeline">
                @for (stage of project()?.details?.stages; track $index) {
                  <div class="stage-item">
                    <div class="stage-marker"></div>
                    <div class="stage-content">
                      <div class="stage-title">Stage {{ $index + 1 }}</div>
                      <div class="stage-amount">{{ stage.amountToRelease }}%</div>
                      <div class="stage-date">{{ formatDate(stage.releaseDate) }}</div>
                    </div>
                  </div>
                }
              </div>
            </div>
            
            <!-- Public Keys -->
            <div class="sidebar-card">
              <h3>Public Keys</h3>
              <div class="detail-item">
                <div class="detail-label">Project ID</div>
                <div class="detail-value monospace">{{ project()?.projectIdentifier }}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Founder Key</div>
                <div class="detail-value monospace">{{ project()?.founderKey }}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Recovery Key</div>
                <div class="detail-value monospace">{{ project()?.details?.founderRecoveryKey }}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Nostr Public Key</div>
                <div class="detail-value monospace">{{ user?.npub }}</div>
              </div>
            </div>
            
            <!-- Additional Details -->
            <div class="sidebar-card">
              <h3>Additional Details</h3>
              <div class="detail-item">
                <div class="detail-label">Created on Bitcoin block</div>
                <div class="detail-value">{{ project()?.createdOnBlock }}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Transaction</div>
                <div class="detail-value">
                  @if(networkService.isMain()) {
                    <a target="_blank" [href]="'https://explorer.angor.io/btc/explorer/transaction/' + project()?.trxId">{{ project()?.trxId | slice:0:8 }}...</a>
                  } @else {
                    <a target="_blank" [href]="'https://explorer.angor.io/tbtc/explorer/transaction/' + project()?.trxId">{{ project()?.trxId | slice:0:8 }}...</a>
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      } @else if (activeTab === 'faq') {
        <div class="faq-section">
          <h2>Frequently Asked Questions</h2>
          
          @if (faqItems.length === 0) {
            <div class="empty-state">
              <span class="material-icons">help_outline</span>
              <p>No FAQ items available for this project yet.</p>
            </div>
          } @else {
            <div class="faq-list">
              @for (faq of faqItems; track faq.id) {
                <div class="faq-item">
                  <h3 class="faq-question">{{ faq.question }}</h3>
                  <p class="faq-answer">{{ faq.answer }}</p>
                </div>
              }
            </div>
          }
        </div>
      } @else if (activeTab === 'updates') {
        <div class="updates-section">
          <h2>Project Updates</h2>
          
          @if (loading()) {
            <div class="loading-container">
              <div class="loading-spinner"></div>
              <p>Loading updates...</p>
            </div>
          } @else if (updates().length === 0) {
            <div class="empty-state">
              <span class="material-icons">notifications_none</span>
              <p>No updates available for this project yet.</p>
            </div>
          } @else {
            <div class="updates-list">
              @for (update of updates(); track update.id) {
                <div class="update-card">
                  <div class="update-header">
                    <span class="update-date">{{ formatDate(update.created_at) }}</span>
                  </div>
                  <div class="update-content" [innerHTML]="update.content | safeContent"></div>
                </div>
              }
            </div>
          }
        </div>
      } @else if (activeTab === 'comments') {
        <div class="comments-section">
          <h2>Comments</h2>
          
          @if (loading()) {
            <div class="loading-container">
              <div class="loading-spinner"></div>
              <p>Loading comments...</p>
            </div>
          } @else if (comments().length === 0) {
            <div class="empty-state">
              <span class="material-icons">chat_bubble_outline</span>
              <p>No comments available for this project yet.</p>
            </div>
          } @else {
            <div class="comments-list">
              @for (comment of comments(); track comment.id) {
                <div class="comment-card">
                  <div class="comment-header">
                    <app-profile
                      [pubkey]="comment.pubkey"
                      [link]="'https://primal.net/p/' + comment.pubkey"
                    ></app-profile>
                    <span class="comment-date">{{ formatDate(comment.created_at) }}</span>
                  </div>
                  <p class="comment-content">{{ comment.content }}</p>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
    
    @if (showImagePopup && selectedImage) {
      <app-image-popup
        [imageUrl]="selectedImage"
        altText="Project media"
        (close)="showImagePopup = false; selectedImage = null"
      ></app-image-popup>
    }
  }
</div>