<section class="relative w-full h-[250px] md:h-[300px] overflow-hidden"> <!-- Adjusted height -->
  <app-breadcrumb [items]="[
        { label: 'Home', url: '/' },
        { label: 'Explore', url: '' }
      ]" class="mb-4"></app-breadcrumb>
  <!-- Banner content remains here -->
  <div
    class="absolute inset-0 bg-cover bg-center transition-colors duration-300 after:content-[''] after:absolute after:inset-0 after:bg-black/30"
    [style.background-image]="project()?.metadata?.banner && !failedBannerImage()
        ? 'url(' + project()?.metadata?.banner + ')'
        : 'none'" [style.background-color]="failedBannerImage() || !project()?.metadata?.banner
        ? getBannerStyle()
        : 'transparent'">
    @if (project()?.metadata?.banner) {
    <img [src]="project()?.metadata?.banner" class="hidden" (error)="handleBannerError()" alt="">
    }
  </div>
</section>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative -mt-[70px] md:-mt-[80px]"> <!-- Adjusted negative margin -->
  @if (isDenied()) {
  <div
    class="flex flex-col items-center justify-center p-8 sm:p-12 mt-12 bg-surface-card rounded-lg shadow-md text-center">
    <span class="material-icons text-6xl text-red-500 mb-6">gpp_bad</span>
    <h1 class="text-2xl font-semibold mb-4">Project Not Available</h1>
    <p class="max-w-lg mb-8 text-text-secondary">
      This project is currently not available for viewing due to content policy violations or other restrictions.
    </p>
    <div class="flex gap-4 max-sm:flex-col">
      <a routerLink="/explore"
        class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium bg-surface-card text-text border border-border hover:bg-surface-hover hover:-translate-y-0.5 hover:shadow-sm transition-all duration-300 ease-in-out">
        <span class="material-icons text-lg">explore</span>
        Explore Other Projects
      </a>
    </div>
  </div>
  } @else if (!project() && indexer.loading()) {
  <div class="flex flex-col items-center justify-center p-12 mt-12 bg-surface-card rounded-lg shadow-md text-center">
    <div class="w-12 h-12 border-4 border-accent/20 border-t-accent rounded-full animate-spin mb-6"></div>
    <p class="text-text-secondary">Loading project details...</p>
  </div>
  } @else if (!project() && !indexer.loading() && noProjectFoundYet) {
  <div
    class="flex flex-col items-center justify-center p-8 sm:p-12 mt-12 bg-surface-card rounded-lg shadow-md text-center">
    <span class="material-icons text-6xl text-text-secondary opacity-50 mb-6">search_off</span>
    <h1 class="text-2xl font-semibold mb-4">Project not found... yet</h1>
    <p class="max-w-lg mb-8 text-text-secondary">
      If you recently created a new Angor project, it might take a few minutes
      for it to be distributed and indexed on the decentralized infrastructure.
    </p>
    <div class="flex gap-4 max-sm:flex-col">
      <button (click)="reloadPage()"
        class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium bg-accent text-white hover:-translate-y-0.5 hover:shadow-md transition-all duration-300 ease-in-out">
        <span class="material-icons text-lg">refresh</span>
        Retry
      </button>
      <a routerLink="/explore"
        class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium bg-surface-card text-text border border-border hover:bg-surface-hover hover:-translate-y-0.5 hover:shadow-sm transition-all duration-300 ease-in-out">
        <span class="material-icons text-lg">explore</span>
        Explore All Projects
      </a>
    </div>
  </div>
  } @else if (project()) {
  <!-- Project Header -->
  <div
    class="grid grid-cols-[auto_1fr] md:grid-cols-[auto_1fr_auto] gap-4 md:gap-6 p-4 sm:p-6 bg-surface-card rounded-xl shadow-lg mb-8 items-start">
    <!-- Adjusted gap/padding -->
    @if (project()?.metadata?.['picture'] && !failedProfileImage()) {
    <img [src]="project()?.metadata?.['picture']"
      class="w-24 h-24 md:w-32 md:h-32 rounded-full object-cover border-4 border-surface-card shadow-md transition-transform duration-300 ease-in-out cursor-pointer hover:scale-105"
      alt="{{ project()?.metadata?.name }} logo" (error)="handleProfileError()"
      (click)="openImagePopup(project()?.metadata?.['picture']!)" />
    } @else {
    <div
      class="w-24 h-24 md:w-32 md:h-32 rounded-full border-4 border-surface-card shadow-md flex items-center justify-center text-white text-4xl font-semibold cursor-default"
      [style.background-color]="getRandomColor(projectId)" (click)="showImagePopup = false">
      {{ getInitial(project()?.metadata?.name || projectId) }}
    </div>
    }

    <div class="flex flex-col gap-2 md:gap-3 min-w-0"> <!-- Adjusted gap -->
      <div class="flex items-start justify-between gap-2">
        <h1 class="m-0 text-xl md:text-3xl font-bold break-words mr-2">{{ project()?.metadata?.name || projectId }}</h1>
        <!-- Adjusted size/margin -->
        <div class="flex gap-1 flex-shrink-0">
          <button [title]="isFavorite() ? 'Remove from bookmarks' : 'Add to bookmarks'"
            [class.text-accent]="isFavorite()" (click)="toggleFavorite()"
            class="bg-transparent border-none text-text-secondary rounded-full w-9 h-9 md:w-10 md:h-10 flex items-center justify-center cursor-pointer transition-all duration-300 ease-in-out hover:bg-surface-hover hover:text-text">
            <span class="material-icons text-lg md:text-xl">{{ isFavorite() ? 'bookmark' : 'bookmark_border' }}</span>
          </button>
          <button [title]="'Report this project'" (click)="reportProject()"
            class="bg-transparent border-none text-text-secondary rounded-full w-9 h-9 md:w-10 md:h-10 flex items-center justify-center cursor-pointer transition-all duration-300 ease-in-out hover:bg-surface-hover hover:text-red-500">
            <span class="material-icons text-lg md:text-xl">report_problem</span>
          </button>
        </div>
      </div>

      <p class="text-sm md:text-base leading-relaxed text-text-secondary m-0 line-clamp-3">{{ project()?.metadata?.about
        }}</p> <!-- Adjusted size -->

      <!-- Project status notification -->
      @if (isProjectSuccessful()) {
      <div class="flex items-center p-3 md:p-4 rounded-lg bg-green-500/10 border-l-4 border-green-500">
        <span class="material-icons status-icon text-green-500 text-2xl mr-3 md:mr-4">check_circle</span>
        <div class="status-message">
          <h3 class="m-0 mb-1 text-base md:text-lg font-semibold text-green-700 dark:text-green-400">Project
            Successfully Funded!</h3>
          <p class="m-0 text-sm md:text-base text-green-600 dark:text-green-500">Reached goal of {{
            bitcoin.toBTC(project()?.details?.targetAmount ?? 0) }} {{ networkService.isMain() ? 'BTC' : 'TBTC' }} ({{
            getFundingPercentage() }}% funded).</p>
        </div>
      </div>
      } @else if (isProjectFailed()) {
      <div class="flex items-center p-3 md:p-4 rounded-lg bg-red-500/10 border-l-4 border-red-500">
        <span class="material-icons status-icon text-red-500 text-2xl mr-3 md:mr-4">error</span>
        <div class="status-message">
          <h3 class="m-0 mb-1 text-base md:text-lg font-semibold text-red-700 dark:text-red-400">Project Did Not Reach
            Funding Goal</h3>
          <p class="m-0 text-sm md:text-base text-red-600 dark:text-red-500">Raised {{
            bitcoin.toBTC(project()?.stats?.amountInvested ?? 0) }} of {{ bitcoin.toBTC(project()?.details?.targetAmount
            ?? 0) }} {{ networkService.isMain() ? 'BTC' : 'TBTC' }} ({{ getFundingPercentage() }}% funded).</p>
        </div>
      </div>
      }

      <!-- External links -->
      @if (project()?.details?.nostrPubKey) {
      <div class="flex flex-wrap gap-2 md:gap-3 mt-1">
        <a [href]="'https://primal.net/p/' + user?.npub" target="_blank"
          class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-surface-ground border border-border rounded-md text-text text-xs md:text-sm font-medium transition-all duration-300 ease-in-out hover:bg-surface-hover hover:-translate-y-0.5 hover:shadow-sm">
          <span class="material-icons text-sm">launch</span> Primal
        </a>
        <a [href]="'https://notes.blockcore.net/p/' + user?.npub" target="_blank"
          class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-surface-ground border border-border rounded-md text-text text-xs md:text-sm font-medium transition-all duration-300 ease-in-out hover:bg-surface-hover hover:-translate-y-0.5 hover:shadow-sm">
          <span class="material-icons text-sm">launch</span> Notes
        </a>
        <a [href]="'https://nostr.at/' + user?.npub" target="_blank"
          class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-surface-ground border border-border rounded-md text-text text-xs md:text-sm font-medium transition-all duration-300 ease-in-out hover:bg-surface-hover hover:-translate-y-0.5 hover:shadow-sm">
          <span class="material-icons text-sm">launch</span> nostr.at
        </a>
      </div>
      }

      <!-- Social links -->
      <div class="flex flex-wrap gap-x-3 md:gap-x-4 gap-y-1 mt-1">
        @for (identity of project()?.externalIdentities; track identity.platform) {
        <a [href]="getSocialLink(identity)" target="_blank"
          class="inline-flex items-center gap-1.5 px-2 py-1 rounded-md text-text-secondary text-xs md:text-sm transition-all duration-300 ease-in-out hover:bg-surface-hover hover:text-text"
          [title]="identity.username">
          <span class="material-icons text-sm md:text-base">{{ getSocialIcon(identity.platform) }}</span>
          <span>{{ formatUsername(identity.username) }}</span>
        </a>
        }
      </div>
    </div>

    <!-- Desktop invest button -->
    <div class="hidden md:flex items-start">
      <button
        class="px-5 py-2.5 md:px-6 md:py-3 text-base md:text-lg font-semibold text-white bg-accent border-none rounded-lg cursor-pointer transition-all duration-300 ease-in-out hover:enabled:-translate-y-0.5 hover:enabled:shadow-md disabled:bg-surface-hover disabled:text-text-secondary disabled:cursor-not-allowed"
        [disabled]="!canInvest()" (click)="canInvest() && openInvestWindow()">
        @if (isProjectEnded()) {
        Ended {{ project()?.details?.expiryDate ?? 0 | ago }}
        } @else if (isProjectNotStarted()) {
        Starts {{ project()?.details?.startDate ?? 0 | ago }} (Invest Now)
        } @else {
        Invest Now
        }
      </button>
    </div>
  </div>

  <!-- Mobile invest button -->
  <div class="md:hidden mb-6 px-4">
    <button
      class="w-full px-6 py-3 text-lg font-semibold text-white bg-accent border-none rounded-lg cursor-pointer transition-all duration-300 ease-in-out hover:enabled:-translate-y-0.5 hover:enabled:shadow-md disabled:bg-surface-hover disabled:text-text-secondary disabled:cursor-not-allowed"
      [disabled]="!canInvest()" (click)="canInvest() && openInvestWindow()">
      @if (isProjectEnded()) {
      Ended {{ project()?.details?.expiryDate ?? 0 | ago }}
      } @else if (isProjectNotStarted()) {
      Starts {{ project()?.details?.startDate ?? 0 | ago }} (Invest Now)
      } @else {
      Invest Now
      }
    </button>
  </div>

  <!-- Stats Dashboard -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-8"> <!-- Adjusted grid layout for two rows -->
    <!-- Funding Card -->
    <div 
      class="flex items-start gap-4 p-4 bg-surface-card rounded-lg shadow-sm relative overflow-hidden transition-all duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-md h-full"
      [style.background]="'linear-gradient(90deg, ' + 
        (getFundingPercentage() >= 100 ? 'rgba(34, 197, 94, 0.08)' : 'rgba(59, 130, 246, 0.08)') + 
        ' ' + (getFundingPercentage() > 100 ? 100 : getFundingPercentage()) + '%, var(--surface-card) ' + 
        (getFundingPercentage() > 100 ? 100 : getFundingPercentage()) + '%)'">
      <div class="w-10 h-10 md:w-12 md:h-12 flex-shrink-0 flex items-center justify-center bg-blue-500/10 rounded-full z-[1]">
        <span class="material-icons text-xl md:text-2xl text-blue-500">campaign</span>
      </div>
      <div class="flex-1 z-[1] min-w-0">
        <div class="flex justify-between items-center mb-1">
          <div class="text-sm text-text-secondary truncate">Total Raised</div>
          <div class="text-xs font-medium px-2 py-0.5 rounded-full flex-shrink-0 ml-2" [ngClass]="getFundingPercentage() >= 100 ? 'bg-green-500/10 text-green-600 dark:text-green-400' : 'bg-blue-500/10 text-blue-600 dark:text-blue-400'">
            {{ getFundingPercentage() }}% of goal
          </div>
        </div>
        <div class="text-xl md:text-2xl font-semibold mb-2 truncate">
          {{ bitcoin.toBTC((project()?.stats?.amountInvested ?? 0)) }}
          <span class="text-sm font-medium text-text-secondary ml-1">{{ networkService.isMain() ? 'BTC' : 'TBTC' }}</span>
        </div>
        <div class="relative w-full h-2 bg-surface-hover rounded-full overflow-hidden">
          <div class="absolute top-0 left-0 h-full transition-width duration-500 ease-out" 
            [class]="getFundingPercentage() >= 100 ? 'bg-green-500' : 'bg-blue-500'" 
            [style.width.%]="getFundingPercentage() > 100 ? 100 : getFundingPercentage()"></div>
        </div>
        <div class="text-xs text-text-secondary mt-1.5 truncate">
          Target: {{ bitcoin.toBTC(project()?.details?.targetAmount ?? 0) }} {{ networkService.isMain() ? 'BTC' : 'TBTC' }}
        </div>
      </div>
    </div>

    <!-- Investors Card -->
    <div class="flex items-start gap-4 p-4 bg-surface-card rounded-lg shadow-sm relative overflow-hidden transition-all duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-md h-full">
      <div class="w-10 h-10 md:w-12 md:h-12 flex-shrink-0 flex items-center justify-center bg-purple-500/10 rounded-full z-[1]">
        <span class="material-icons text-xl md:text-2xl text-purple-500">people</span>
      </div>
      <div class="flex-1 z-[1] min-w-0">
        <div class="text-sm text-text-secondary mb-1 truncate">Total Investors</div>
        <div class="text-xl md:text-2xl font-semibold truncate">
          {{ project()?.stats?.investorCount || '0' }}
          @if (project()?.stats?.investorCount) {
            <span class="text-sm font-medium ml-2 inline-flex items-center text-green-500">
              <span class="material-icons text-base">trending_up</span>
            </span>
          }
        </div>
      </div>
    </div>

    <!-- Spent Card -->
    <div 
      class="flex items-start gap-4 p-4 bg-surface-card rounded-lg shadow-sm relative overflow-hidden transition-all duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-md h-full"
      [style.background]="'linear-gradient(90deg, rgba(245, 158, 11, 0.08) ' + getSpentPercentage() + '%, var(--surface-card) ' + getSpentPercentage() + '%)'">
      <div class="w-10 h-10 md:w-12 md:h-12 flex-shrink-0 flex items-center justify-center bg-orange-500/10 rounded-full z-[1]">
        <span class="material-icons text-xl md:text-2xl text-orange-500">account_balance_wallet</span>
      </div>
      <div class="flex-1 z-[1] min-w-0">
        <div class="flex justify-between items-center mb-1">
          <div class="text-sm text-text-secondary truncate">Founder Spent</div>
          <div class="text-xs font-medium px-2 py-0.5 rounded-full bg-orange-500/10 text-orange-600 dark:text-orange-400 flex-shrink-0 ml-2">
            {{ getSpentPercentage() }}% of funds
          </div>
        </div>
        <div class="text-xl md:text-2xl font-semibold mb-2 truncate">
          {{ bitcoin.toBTC((project()?.stats?.amountSpentSoFarByFounder ?? 0)) }}
          <span class="text-sm font-medium text-text-secondary ml-1">{{ networkService.isMain() ? 'BTC' : 'TBTC' }}</span>
        </div>
        <div class="relative w-full h-2 bg-surface-hover rounded-full overflow-hidden">
          <div class="absolute top-0 left-0 h-full bg-orange-500 transition-width duration-500 ease-out" [style.width.%]="getSpentPercentage()"></div>
        </div>
      </div>
    </div>

    <!-- Withdrawn Card -->
    <div 
      class="flex items-start gap-4 p-4 bg-surface-card rounded-lg shadow-sm relative overflow-hidden transition-all duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-md h-full"
      [style.background]="'linear-gradient(90deg, rgba(239, 68, 68, 0.08) ' + getWithdrawnPercentage() + '%, var(--surface-card) ' + getWithdrawnPercentage() + '%)'">
      <div class="w-10 h-10 md:w-12 md:h-12 flex-shrink-0 flex items-center justify-center bg-red-500/10 rounded-full z-[1]">
        <span class="material-icons text-xl md:text-2xl text-red-500">logout</span>
      </div>
      <div class="flex-1 z-[1] min-w-0">
        <div class="flex justify-between items-center mb-1">
          <div class="text-sm text-text-secondary truncate">Investor Withdrawn</div>
          <div class="text-xs font-medium px-2 py-0.5 rounded-full bg-red-500/10 text-red-600 dark:text-red-400 flex-shrink-0 ml-2">
            {{ getWithdrawnPercentage() }}% of funds
          </div>
        </div>
        <div class="text-xl md:text-2xl font-semibold mb-2 truncate">
          {{ bitcoin.toBTC((project()?.stats?.amountInPenalties ?? 0)) }}
          <span class="text-sm font-medium text-text-secondary ml-1">{{ networkService.isMain() ? 'BTC' : 'TBTC' }}</span>
        </div>
        <div class="relative w-full h-2 bg-surface-hover rounded-full overflow-hidden">
          <div class="absolute top-0 left-0 h-full bg-red-500 transition-width duration-500 ease-out" [style.width.%]="getWithdrawnPercentage()"></div>
        </div>
      </div>
    </div>

    <!-- Penalties Card -->
    <div 
      class="flex items-start gap-4 p-4 bg-surface-card rounded-lg shadow-sm relative overflow-hidden transition-all duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-md h-full"
      [style.background]="'linear-gradient(90deg, rgba(239, 68, 68, 0.08) ' + getPenaltiesPercentage() + '%, var(--surface-card) ' + getPenaltiesPercentage() + '%)'">
      <div class="w-10 h-10 md:w-12 md:h-12 flex-shrink-0 flex items-center justify-center bg-red-500/10 rounded-full z-[1]">
        <span class="material-icons text-xl md:text-2xl text-red-500">trending_down</span>
      </div>
      <div class="flex-1 z-[1] min-w-0">
        <div class="flex justify-between items-center mb-1">
          <div class="text-sm text-text-secondary truncate">Withdrawn by Investors</div>
          <div class="text-xs font-medium px-2 py-0.5 rounded-full bg-red-500/10 text-red-600 dark:text-red-400 flex-shrink-0 ml-2">
            {{ project()?.stats?.countInPenalties || '0' }} investors
          </div>
        </div>
        <div class="text-xl md:text-2xl font-semibold mb-2 truncate">
          {{ bitcoin.toBTC((project()?.stats?.amountInPenalties ?? 0)) }}
          <span class="text-sm font-medium text-text-secondary ml-1">{{ networkService.isMain() ? 'BTC' : 'TBTC' }}</span>
        </div>
        <div class="relative w-full h-2 bg-surface-hover rounded-full overflow-hidden">
          <div class="absolute top-0 left-0 h-full bg-red-500 transition-width duration-500 ease-out" [style.width.%]="getPenaltiesPercentage()"></div>
        </div>
      </div>
    </div>

    <!-- Semi-transparent overlay for visual flair, could be empty -->
    <div class="md:col-span-2 lg:col-span-3 flex items-center justify-center p-3 rounded-lg bg-surface-card/50 shadow-sm">
      <p class="text-sm text-center text-text-secondary m-0">
        <span class="material-icons align-middle text-sm mr-1">info</span>
        Project statistics are updated in real-time from the blockchain
      </p>
    </div>
  </div>

  <!-- New Layout: Vertical Tabs + Content Area -->
  <div class="grid grid-cols-1 md:grid-cols-[240px_1fr] gap-4 md:gap-8 mb-12">
    <!-- Vertical Tabs Navigation -->
    <div class="flex flex-row flex-wrap md:flex-col gap-2 h-fit rounded-xl bg-surface-card p-4 shadow-md">
      @for (tab of tabs; track tab.id) {
      <div
        class="flex items-center gap-4 p-3 md:p-4 rounded-lg cursor-pointer transition duration-200 ease-in-out text-text hover:bg-surface-hover hover:text-accent flex-1 md:flex-none justify-center md:justify-start"
        [class.bg-accent]="activeTab === tab.id" [class.text-white]="activeTab === tab.id"
        (click)="setActiveTab(tab.id)">
        <span class="material-icons text-text-secondary transition duration-200 ease-in-out"
          [class.text-white]="activeTab === tab.id">{{ tab.icon }}</span>
        <span class="hidden md:inline">{{ tab.label }}</span>
      </div>
      }
    </div>

    <!-- Tab content -->
    <div class="flex flex-col gap-6"> <!-- Added container for content -->
      @if (activeTab === 'project') {
      <div class="grid grid-cols-1 lg:grid-cols-[1.5fr_1fr] gap-6 md:gap-8">
        <div class="flex flex-col gap-6 md:gap-8">
          @if (project()?.content) {
          <!-- Media carousel -->
          @if (project()?.media?.length) {
          <div class="relative w-full rounded-lg overflow-hidden aspect-video shadow-md bg-surface-hover">
            <div class="flex h-full transition-transform duration-300 ease-in-out"
              [style.transform]="'translateX(' + -currentSlide * 100 + '%)'">
              @for (item of project()?.media; track item.url) {
              @if (item.type === 'image') {
              <div class="min-w-full h-full flex-shrink-0">
                @if (!hasMediaFailed(item.url)) {
                <img [src]="item.url" alt="Project media" loading="lazy"
                  class="w-full h-full object-cover cursor-pointer"
                  (click)="showImagePopup = true; selectedImage = item.url" (error)="handleMediaError(item.url)" />
                } @else {
                <div class="w-full h-full flex items-center justify-center bg-surface-ground"
                  [style.background-color]="getRandomColor(item.url)" (click)="showImagePopup = false">
                  <span class="material-icons text-4xl text-white/70">broken_image</span>
                </div>
                }
              </div>
              }
              }
            </div>

            @if ((project()?.media?.length ?? 0) > 1) {
            <button
              class="absolute top-1/2 -translate-y-1/2 left-2 md:left-4 w-9 h-9 md:w-10 md:h-10 bg-black/40 text-white border-none rounded-full flex items-center justify-center cursor-pointer transition-all duration-300 ease-in-out hover:bg-black/60"
              (click)="prevSlide()">
              <span class="material-icons">chevron_left</span>
            </button>
            <button
              class="absolute top-1/2 -translate-y-1/2 right-2 md:right-4 w-9 h-9 md:w-10 md:h-10 bg-black/40 text-white border-none rounded-full flex items-center justify-center cursor-pointer transition-all duration-300 ease-in-out hover:bg-black/60"
              (click)="nextSlide()">
              <span class="material-icons">chevron_right</span>
            </button>

            <div class="absolute bottom-3 md:bottom-4 left-1/2 -translate-x-1/2 flex gap-1.5 md:gap-2">
              @for (item of project()?.media; track $index) {
              <button
                class="w-2 h-2 md:w-2.5 md:h-2.5 rounded-full bg-white/50 border-none cursor-pointer transition-all duration-300 ease-in-out"
                [class.bg-white]="currentSlide === $index" (click)="currentSlide = $index"></button>
              }
            </div>
            }
          </div>
          }

          <!-- Project content -->
          <div class="bg-surface-card rounded-lg shadow-sm p-4 sm:p-6 overflow-hidden"> <!-- Adjusted padding -->
            <h2 class="mt-0 mb-5 pb-3 border-b border-border text-xl font-semibold">About This Project</h2>
            <!-- Adjusted margin/padding -->
            <markdown [data]="project()?.content"
              class="prose prose-sm sm:prose max-w-none prose-headings:mt-6 prose-headings:mb-3 prose-p:mb-4 prose-img:rounded-md prose-img:my-5 prose-code:bg-surface-hover prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-pre:bg-surface-hover prose-pre:p-4 prose-pre:rounded-md prose-pre:overflow-x-auto prose-a:text-accent prose-a:no-underline hover:prose-a:underline prose-blockquote:border-l-4 prose-blockquote:border-accent prose-blockquote:pl-4 prose-blockquote:ml-0 prose-blockquote:text-text-secondary dark:prose-invert dark:prose-headings:text-text dark:prose-p:text-text-secondary dark:prose-a:text-accent-light dark:prose-blockquote:text-text-secondary dark:prose-code:bg-surface-ground dark:prose-pre:bg-surface-ground">
            </markdown> <!-- Adjusted prose styles and theme colors -->
          </div>

          <!-- Project members -->
          @if (project()?.members?.length) {
          <div class="bg-surface-card rounded-lg shadow-sm p-4 sm:p-6 overflow-hidden"> <!-- Adjusted padding -->
            <h2 class="mt-0 mb-5 pb-3 border-b border-border text-xl font-semibold">Project Team</h2>
            <!-- Adjusted margin/padding -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"> <!-- Adjusted gap -->
              @for (member of project()?.members; track member) {
              <div
                class="bg-surface-ground rounded-md p-3 transition-all duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-sm">
                <!-- Adjusted padding -->
                <app-profile [npub]="member" [link]="'https://primal.net/p/' + member"></app-profile>
              </div>
              }
            </div>
          </div>
          }
          } @else {
          <div class="bg-surface-card rounded-lg shadow-sm p-8 text-center text-text-secondary">
            <span class="material-icons text-4xl mb-4 opacity-50">description</span>
            <p>No project description provided.</p>
          </div>
          }
        </div>

        <!-- Project sidebar -->
        <div class="flex flex-col gap-6 md:gap-8">
          <!-- Project Details -->
          <div class="bg-surface-card rounded-lg shadow-sm p-4 sm:p-5 overflow-hidden"> <!-- Adjusted padding -->
            <h3 class="mt-0 mb-5 pb-3 border-b border-border text-lg font-semibold">Project Details</h3>
            <!-- Adjusted margin/padding -->
            <div class="mb-4">
              <div class="text-sm text-text-secondary mb-1">Start Date</div>
              <div class="text-text font-medium">
                {{ formatDate(project()?.details?.startDate) }}
                @if (project()?.details?.startDate) {
                <span class="block text-xs text-text-secondary mt-1 italic">
                  @if (isProjectNotStarted()) {
                  (Starts {{ project()?.details?.startDate ?? 0 | ago }})

                  } @else {
                  (Started {{ project()?.details?.startDate ?? 0 | ago }})
                  }
                </span>
                }
              </div>
            </div>
            <div class="mb-4">
              <div class="text-sm text-text-secondary mb-1">Expiry Date</div>
              <div class="text-text font-medium">
                {{ formatDate(project()?.details?.expiryDate) }}
                @if (project()?.details?.expiryDate) {
                <span class="block text-xs text-text-secondary mt-1 italic">
                  @if (isProjectEnded()) {
                  (Ended {{ project()?.details?.expiryDate ?? 0 | ago }})
                  } @else {
                  ({{ getRemainingTimeText(project()?.details?.expiryDate) }})
                  }
                </span>
                } @else {
                <span class="block text-xs text-text-secondary mt-1 italic">(No expiry date)</span>
                }
              </div>
            </div>
            <div class="mb-0"> <!-- Last item -->
              <div class="text-sm text-text-secondary mb-1">Penalty Days</div>
              <div class="text-text font-medium">{{ project()?.details?.penaltyDays }} days</div>
            </div>
          </div>

          <!-- Funding Stages -->
          @if (project()?.details?.stages?.length) {
          <div class="bg-surface-card rounded-lg shadow-sm p-4 sm:p-5 overflow-hidden"> <!-- Adjusted padding -->
            <h3 class="mt-0 mb-5 pb-3 border-b border-border text-lg font-semibold">Funding Stages</h3>
            <!-- Adjusted margin/padding -->
            <div class="relative">
              @for (stage of project()?.details?.stages; track $index; let isLast = $last) {
              <div class="relative pl-8 pb-6">
                <!-- Timeline line -->
                @if (!isLast) {
                <div class="absolute top-2 left-[11px] w-0.5 h-full bg-border"></div>
                }
                <!-- Marker -->
                <div class="absolute top-0 left-0 w-6 h-6 bg-accent border-4 border-surface-card rounded-full z-[1]">
                </div>
                <!-- Content -->
                <div class="pt-0.5">
                  <div class="font-semibold mb-1">Stage {{ $index + 1 }}</div>
                  <div class="text-lg font-bold text-accent mb-1">{{ stage.amountToRelease }}%</div>
                  <div class="text-sm text-text-secondary">{{ formatDate(stage.releaseDate) }}</div>
                </div>
              </div>
              }
            </div>
          </div>
          }

          <!-- Public Keys -->
          <div class="bg-surface-card rounded-lg shadow-sm p-4 sm:p-5 overflow-hidden"> <!-- Adjusted padding -->
            <h3 class="mt-0 mb-5 pb-3 border-b border-border text-lg font-semibold">Public Keys & IDs</h3>
            <!-- Adjusted margin/padding -->
            <div class="mb-4">
              <div class="text-sm text-text-secondary mb-1">Project ID</div>
              <div class="text-text font-medium font-mono text-xs break-all">{{ project()?.projectIdentifier }}</div>
            </div>
            <div class="mb-4">
              <div class="text-sm text-text-secondary mb-1">Founder Key</div>
              <div class="text-text font-medium font-mono text-xs break-all">{{ project()?.founderKey }}</div>
            </div>
            <div class="mb-4">
              <div class="text-sm text-text-secondary mb-1">Recovery Key</div>
              <div class="text-text font-medium font-mono text-xs break-all">{{ project()?.details?.founderRecoveryKey
                }}</div>
            </div>
            <div class="mb-0"> <!-- Last item -->
              <div class="text-sm text-text-secondary mb-1">Nostr Public Key (npub)</div>
              <div class="text-text font-medium font-mono text-xs break-all">{{ user?.npub }}</div>
            </div>
          </div>

          <!-- Additional Details -->
          <div class="bg-surface-card rounded-lg shadow-sm p-4 sm:p-5 overflow-hidden"> <!-- Adjusted padding -->
            <h3 class="mt-0 mb-5 pb-3 border-b border-border text-lg font-semibold">Blockchain Details</h3>
            <!-- Adjusted margin/padding -->
            <div class="mb-4">
              <div class="text-sm text-text-secondary mb-1">Created on Bitcoin block</div>
              <div class="text-text font-medium">{{ project()?.createdOnBlock }}</div>
            </div>
            <div class="mb-0"> <!-- Last item -->
              <div class="text-sm text-text-secondary mb-1">Transaction ID</div>
              <div class="text-text font-medium font-mono text-xs break-all">
                @if(networkService.isMain()) {
                <a target="_blank" [href]="'https://mempool.space/tx/' + project()?.trxId"
                  class="text-accent hover:underline">{{ project()?.trxId }}</a>
                } @else {
                <a target="_blank" [href]="'https://mempool.space/testnet/tx/' + project()?.trxId"
                  class="text-accent hover:underline">{{ project()?.trxId }}</a>
                }
              </div>
            </div>
          </div>
        </div> <!-- END Project Right Column (Sidebar) -->
      </div> <!-- END Project Inner Grid -->
      } @else if (activeTab === 'faq') {
      <div class="faq-section max-w-3xl mx-auto"> <!-- Centered content -->
        <h2 class="text-xl font-semibold mb-6 pb-4 border-b border-border">Frequently Asked Questions</h2>

        @if (loadingFaq()) {
        <div class="flex flex-col items-center justify-center p-8 text-text-secondary">
          <div class="w-8 h-8 border-3 border-accent/30 border-t-accent rounded-full animate-spin mb-4"></div>
          <p>Loading FAQ...</p>
        </div>
        } @else if (errorFaq()) {
        <div class="flex flex-col items-center justify-center p-8 text-center text-warning bg-red-500/5 rounded-lg">
          <span class="material-icons text-5xl mb-4 opacity-80">error_outline</span>
          <p>{{ errorFaq() }}</p>
          <button (click)="fetchFaq()"
            class="mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-accent text-white hover:-translate-y-0.5 hover:shadow-sm transition-all duration-300 ease-in-out">
            <span class="material-icons text-lg">refresh</span>
            Retry
          </button>
        </div>
        } @else if (faqItems().length === 0) {
        <div
          class="flex flex-col items-center justify-center p-8 text-center text-text-secondary bg-surface-card rounded-lg shadow-sm">
          <span class="material-icons text-5xl mb-4 opacity-50">help_outline</span>
          <p>No FAQ items available for this project yet.</p>
        </div>
        } @else {
        <div class="flex flex-col gap-4 md:gap-6">
          @for (faq of faqItems(); track faq.id) {
          <div
            class="bg-surface-card rounded-lg shadow-sm p-4 sm:p-6 transition-all duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-md">
            <h3 class="mt-0 mb-3 text-lg font-semibold">{{ faq.question }}</h3>
            <!-- Use markdown pipe if answer can contain markdown, otherwise keep as is -->
            <p class="m-0 text-base text-text-secondary whitespace-pre-wrap">{{ faq.answer }}</p>
          </div>
          }
        </div>
        }
      </div>
      } @else if (activeTab === 'updates') {
      <div class="updates-section max-w-3xl mx-auto"> <!-- Centered content -->
        <h2 class="text-xl font-semibold mb-6 pb-4 border-b border-border">Project Updates</h2>

        @if (loadingUpdates()) {
        <div class="flex flex-col items-center justify-center p-8 text-text-secondary">
          <div class="w-8 h-8 border-3 border-accent/30 border-t-accent rounded-full animate-spin mb-4"></div>
          <p>Loading updates...</p>
        </div>
        } @else if (errorUpdates()) {
        <div class="flex flex-col items-center justify-center p-8 text-center text-warning bg-red-500/5 rounded-lg">
          <span class="material-icons text-5xl mb-4 opacity-80">error_outline</span>
          <p>{{ errorUpdates() }}</p>
          <button (click)="fetchUpdates()"
            class="mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-accent text-white hover:-translate-y-0.5 hover:shadow-sm transition-all duration-300 ease-in-out">
            <span class="material-icons text-lg">refresh</span>
            Retry
          </button>
        </div>
        } @else if (updates().length === 0) {
        <div
          class="flex flex-col items-center justify-center p-8 text-center text-text-secondary bg-surface-card rounded-lg shadow-sm">
          <span class="material-icons text-5xl mb-4 opacity-50">campaign</span> <!-- Changed icon -->
          <p>No updates available for this project yet.</p>
        </div>
        } @else {
        <div class="flex flex-col gap-4 md:gap-6">
          @for (update of updates(); track update.id) {
          <div
            class="bg-surface-card rounded-lg shadow-sm p-4 sm:p-6 transition-all duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-md">
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-border">
              <!-- Assuming updates are from the project owner -->
              <app-profile [pubkey]="update.pubkey" [link]="'https://primal.net/p/' + update.pubkey"
                class="text-sm"></app-profile>
              <span class="text-sm text-text-secondary flex-shrink-0 ml-4">{{ update.created_at ?? 0 | ago }}</span>
            </div>
            <!-- Using prose for markdown-like styling of Nostr content -->
            <div
              class="prose prose-sm sm:prose max-w-none dark:prose-invert prose-a:text-accent hover:prose-a:underline prose-img:rounded-md prose-img:max-h-80 prose-img:mx-auto"
              [innerHTML]="update.content | safeContent"></div>
          </div>
          }
        </div>
        }
      </div>
      } @else if (activeTab === 'comments') {
      <div class="comments-section max-w-3xl mx-auto"> <!-- Centered content -->
        <h2 class="text-xl font-semibold mb-6 pb-4 border-b border-border">Comments</h2>

        @if (loadingComments()) {
        <div class="flex flex-col items-center justify-center p-8 text-text-secondary">
          <div class="w-8 h-8 border-3 border-accent/30 border-t-accent rounded-full animate-spin mb-4"></div>
          <p>Loading comments...</p>
        </div>
        } @else if (errorComments()) {
        <div class="flex flex-col items-center justify-center p-8 text-center text-warning bg-red-500/5 rounded-lg">
          <span class="material-icons text-5xl mb-4 opacity-80">error_outline</span>
          <p>{{ errorComments() }}</p>
          <button (click)="fetchComments()"
            class="mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-accent text-white hover:-translate-y-0.5 hover:shadow-sm transition-all duration-300 ease-in-out">
            <span class="material-icons text-lg">refresh</span>
            Retry
          </button>
        </div>
        } @else if (comments().length === 0) {
        <div
          class="flex flex-col items-center justify-center p-8 text-center text-text-secondary bg-surface-card rounded-lg shadow-sm">
          <span class="material-icons text-5xl mb-4 opacity-50">chat_bubble_outline</span>
          <p>No comments available for this project yet. Be the first to comment!</p> <!-- Encouragement -->
        </div>
        } @else {
        <div class="flex flex-col gap-4 md:gap-6">
          @for (comment of comments(); track comment.id) {
          <div
            class="bg-surface-card rounded-lg shadow-sm p-4 sm:p-6 transition-all duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-md">
            <div class="flex justify-between items-start mb-3 pb-3 border-b border-border gap-4">
              <!-- Use items-start for alignment -->
              <app-profile [pubkey]="comment.pubkey" [link]="'https://primal.net/p/' + comment.pubkey"
                class="text-sm flex-grow min-w-0"></app-profile>
              <span class="text-sm text-text-secondary flex-shrink-0 whitespace-nowrap">{{ comment.created_at ?? 0 | ago
                }}</span>
            </div>
            <!-- Using prose for basic styling, adjust as needed -->
            <div
              class="prose prose-sm sm:prose max-w-none dark:prose-invert prose-a:text-accent hover:prose-a:underline"
              [innerHTML]="comment.content | safeContent"></div>
          </div>
          }
        </div>
        }
      </div> <!-- Closes comments-section div -->
      }
    </div> <!-- Closes Tab content container -->
  </div> <!-- Closes grid -->

  <!-- Image Popup -->
  @if (showImagePopup && selectedImage) {
  <app-image-popup [imageUrl]="selectedImage" altText="Project media"
    (close)="showImagePopup = false; selectedImage = null"></app-image-popup>
  }
  }

</div> <!-- Closes the max-w-7xl container -->