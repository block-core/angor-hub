<section class="hero explore-hero">
  <app-breadcrumb
    [items]="[
      { label: 'Home', url: '/' },
      { label: 'Explore', url: '' }
    ]"
  ></app-breadcrumb>

  <div class="hero-wrapper">
    <div class="hero-content">
      <strong class="hero-explore">Discover Innovation</strong>
      <h1 class="hero-subtitle">Explore Bitcoin Projects</h1>
      <p class="hero-description">
        Find exciting projects building on Bitcoin technology and join the future of decentralized finance.
      </p>
      
      @if (networkService.isMain()) {
        <div class="network-badge">
          <span class="material-icons">warning</span>
          <span>Bitcoin Mainnet - Not yet released</span>
        </div>
      } @else {
        <div class="network-badge testnet">
          <span class="material-icons">science</span>
          <span>Bitcoin Testnet</span>
        </div>
      }
    </div>

    <!-- Compact search and filter controls -->
    <div class="explore-controls-container">
      <div class="explore-controls-wrapper">
        <div class="controls-layout">
          <!-- Search box -->
          <div class="search-container">
            <span class="material-icons search-icon">search</span>
            <input 
              type="text" 
              placeholder="Search projects..." 
              class="search-input"
              [value]="searchTerm()" 
              (input)="onSearchInput($event)"
              aria-label="Search projects">
          </div>
          
          <!-- Filter and Sort Dropdowns - Desktop Layout -->
          <div class="filter-sort-container desktop-view">
            <!-- Filter dropdown -->
            <div class="dropdown-control filter-dropdown" [class.active]="showFilterDropdown">
              <button class="dropdown-button" (click)="toggleFilterDropdown($event)">
                <span class="dropdown-label">Filter: {{ activeFilter() | titlecase }}</span>
                <span class="material-icons">{{ showFilterDropdown ? 'arrow_drop_up' : 'arrow_drop_down' }}</span>
              </button>
              @if (showFilterDropdown) {
                <div class="dropdown-menu">
                  <button class="dropdown-item" [class.selected]="activeFilter() === 'all'" (click)="setFilter('all')">
                    <span class="material-icons">apps</span>
                    <span>All</span>
                  </button>
                  <button class="dropdown-item" [class.selected]="activeFilter() === 'active'" (click)="setFilter('active')">
                    <span class="material-icons">timelapse</span>
                    <span>Active</span>
                  </button>
                  <button class="dropdown-item" [class.selected]="activeFilter() === 'upcoming'" (click)="setFilter('upcoming')">
                    <span class="material-icons">hourglass_top</span>
                    <span>Upcoming</span>
                  </button>
                  <button class="dropdown-item" [class.selected]="activeFilter() === 'completed'" (click)="setFilter('completed')">
                    <span class="material-icons">flag</span>
                    <span>Completed</span>
                  </button>
                </div>
              }
            </div>

            <!-- Sort dropdown -->
            <div class="dropdown-control sort-dropdown" [class.active]="showSortDropdown">
              <button class="dropdown-button" (click)="toggleSortDropdown($event)">
                <span class="dropdown-label">Sort: {{ activeSort() | titlecase }}</span>
                <span class="material-icons">{{ showSortDropdown ? 'arrow_drop_up' : 'arrow_drop_down' }}</span>
              </button>
              @if (showSortDropdown) {
                <div class="dropdown-menu">
                  <button class="dropdown-item" [class.selected]="activeSort() === 'default'" (click)="setSort('default')">
                    <span class="material-icons">sort</span>
                    <span>Default</span>
                  </button>
                  <button class="dropdown-item" [class.selected]="activeSort() === 'funding'" (click)="setSort('funding')">
                    <span class="material-icons">trending_up</span>
                    <span>Funding</span>
                  </button>
                  <button class="dropdown-item" [class.selected]="activeSort() === 'endDate'" (click)="setSort('endDate')">
                    <span class="material-icons">event</span>
                    <span>End Date</span>
                  </button>
                  <button class="dropdown-item" [class.selected]="activeSort() === 'investors'" (click)="setSort('investors')">
                    <span class="material-icons">people</span>
                    <span>Investors</span>
                  </button>
                </div>
              }
            </div>
            
            <!-- Reset button -->
            @if (searchTerm() || activeFilter() !== 'all' || activeSort() !== 'default') {
              <button class="reset-button" (click)="resetFilters()">
                <span class="material-icons">refresh</span>
              </button>
            }
          </div>
          
          <!-- Mobile Filter/Sort Trigger -->
          <button class="mobile-filter-trigger" (click)="toggleMobileFilters()" [class.active]="showMobileFilters">
            <span class="material-icons">{{ showMobileFilters ? 'close' : 'filter_list' }}</span>
            <span>{{ showMobileFilters ? 'Close' : 'Filters' }}</span>
          </button>
        </div>
        
        <!-- Mobile Filters Panel -->
        @if (showMobileFilters) {
          <div class="mobile-filters-panel">
            <div class="mobile-filter-group">
              <h4 class="mobile-filter-heading">Filter by Status</h4>
              <div class="mobile-filter-options">
                <button 
                  class="mobile-filter-button" 
                  [class.active]="activeFilter() === 'all'"
                  (click)="setFilter('all')">
                  <span class="material-icons">apps</span>
                  <span>All</span>
                </button>
                <button 
                  class="mobile-filter-button" 
                  [class.active]="activeFilter() === 'active'"
                  (click)="setFilter('active')">
                  <span class="material-icons">timelapse</span>
                  <span>Active</span>
                </button>
                <button 
                  class="mobile-filter-button" 
                  [class.active]="activeFilter() === 'upcoming'"
                  (click)="setFilter('upcoming')">
                  <span class="material-icons">hourglass_top</span>
                  <span>Upcoming</span>
                </button>
                <button 
                  class="mobile-filter-button" 
                  [class.active]="activeFilter() === 'completed'"
                  (click)="setFilter('completed')">
                  <span class="material-icons">flag</span>
                  <span>Completed</span>
                </button>
              </div>
            </div>
            
            <div class="mobile-filter-group">
              <h4 class="mobile-filter-heading">Sort by</h4>
              <div class="mobile-filter-options">
                <button 
                  class="mobile-filter-button" 
                  [class.active]="activeSort() === 'default'"
                  (click)="setSort('default')">
                  <span class="material-icons">sort</span>
                  <span>Default</span>
                </button>
                <button 
                  class="mobile-filter-button" 
                  [class.active]="activeSort() === 'funding'"
                  (click)="setSort('funding')">
                  <span class="material-icons">trending_up</span>
                  <span>Funding</span>
                </button>
                <button 
                  class="mobile-filter-button" 
                  [class.active]="activeSort() === 'endDate'"
                  (click)="setSort('endDate')">
                  <span class="material-icons">event</span>
                  <span>End Date</span>
                </button>
                <button 
                  class="mobile-filter-button" 
                  [class.active]="activeSort() === 'investors'"
                  (click)="setSort('investors')">
                  <span class="material-icons">people</span>
                  <span>Investors</span>
                </button>
              </div>
            </div>
            
            @if (searchTerm() || activeFilter() !== 'all' || activeSort() !== 'default') {
              <div class="mobile-filter-actions">
                <button class="mobile-reset-button" (click)="resetFilters()">
                  <span class="material-icons">refresh</span>
                  <span>Reset Filters</span>
                </button>
                <div class="mobile-results-count">
                  {{ filteredProjects().length }} project{{ filteredProjects().length !== 1 ? 's' : '' }} found
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>
</section>

<div class="container">
  @if (indexer.loading() && !filteredProjects().length) {
    <div class="loading-spinner">
      <div class="spinner"></div>
    </div>
  } @else {
    @if (filteredProjects().length === 0) {
      <div class="empty-state">
        <div class="empty-icon">
          <span class="material-icons">search_off</span>
        </div>
        <h2>No Projects Match Your Criteria</h2>
        <p>Try adjusting your search, filter, or sort options, or check back later.</p>
        <button class="secondary-button" (click)="resetFilters()">
          <span class="material-icons">clear_all</span>
          Clear Filters & Search
        </button>
      </div>
    } @else {
      <section class="projects">
        @for (project of filteredProjects(); track project.projectIdentifier; let i = $index) {
          <a [routerLink]="['/project', project.projectIdentifier]" class="project-card" [attr.data-index]="i">
            <div
              class="project-banner"
              [style.background-image]="
                project.metadata?.['banner'] ?? ''
                  ? 'url(' + (project.metadata?.['banner'] ?? '') + ')'
                  : 'none'
              "
            >
              @if (isProjectEnded(project.details?.expiryDate)) {
                @if (isProjectSuccessfullyFunded(project)) {
                  <span class="material-icons status-icon status-funded">check_circle</span>
                } @else {
                  <span class="material-icons status-icon status-failed">cancel</span>
                }
              }
              
              @if (isFavorite(project.projectIdentifier)) {
                <span class="favorite-badge">
                  <span class="material-icons">bookmark</span>
                </span>
              }
            </div>

            <div class="project-content">
              @if (project.details) {
                <div
                  class="project-avatar"
                  [style.background-image]="
                    project.metadata?.['picture'] ?? ''
                      ? 'url(' + (project.metadata?.['picture'] ?? '') + ')'
                      : 'none'
                  "
                ></div>

                <div class="project-header">
                  <h3 class="project-title">
                    @if ((project.metadata?.['name'] ?? '') !== '') {
                      {{ project.metadata?.['name'] }}
                    } @else {
                      {{ project.projectIdentifier | slice:0:12 }}...
                    }
                  </h3>
                  
                  <div class="project-date">
                    <span class="material-icons date-icon">event</span>
                    <span>{{ isProjectEnded(project.details.expiryDate) ? 'Ended' : 'Ends' }} {{ project.details.expiryDate | ago }}</span>
                  </div>
                </div>
                
                @if ((project.metadata?.['about'] ?? '') !== '') {
                  <p class="project-description">
                    {{ (project.metadata?.['about'] ?? '') | slice:0:100 }}{{ ((project.metadata?.['about'] ?? '').length > 100) ? '...' : '' }}
                  </p>
                } @else {
                  <p class="project-description placeholder">No description available</p>
                }

                <div class="funding-progress">
                  <div class="progress-info">
                    <div class="investor-count">
                      <span class="material-icons">people</span>
                      <span class="count">{{ project.stats?.investorCount ?? 0 }}</span>
                      <span class="label">Investors</span>
                    </div>
                    
                    <div class="amount-raised">
                      <span class="btc-amount">{{ bitcoin.toBTC(project.stats?.amountInvested ?? 0) }}</span>
                      <span class="symbol">{{ networkService.isMain() ? 'BTC' : 'TBTC' }}</span>
                      <span class="divider">/</span>
                      <span class="target">{{ bitcoin.toBTC(project.details.targetAmount) }}</span>
                    </div>
                  </div>
                  
                  <div class="progress-bar">
                    @let fundingPercent = getFundingPercentage(project);
                    @let displayWidth = fundingPercent > 100 ? 100 : fundingPercent;
                    
                    <span class="percentage" [class.high-funding]="fundingPercent >= 100">
                      {{ fundingPercent }}%
                    </span>
                    
                    <div class="progress-fill" 
                         [style.width]="displayWidth + '%'"
                         [class.high-funding]="fundingPercent >= 100"
                         [class.low-funding]="fundingPercent > 0 && fundingPercent < 15">
                    </div>
                  </div>
                </div>
                
                <div class="project-footer">
                  @if (isProjectNotStarted(project.details.startDate)) {
                    <div class="tag">
                      <span class="material-icons">hourglass_top</span>
                      <span>Upcoming</span>
                    </div>
                  } @else if (!isProjectEnded(project.details.expiryDate)) {
                    <div class="tag active">
                      <span class="material-icons">timelapse</span>
                      <span>Active</span>
                    </div>
                  } @else {
                    <div class="tag ended">
                      <span class="material-icons">flag</span>
                      <span>Completed</span>
                    </div>
                  }
                  
                  <button class="action-button">
                    <span class="material-icons">arrow_forward</span>
                  </button>
                </div>
              }
            </div>
          </a>
        }
      </section>

      @if (!indexer.isComplete()) {
        @if (indexer.loading()) {
          <div class="loading-spinner">
            <div class="spinner"></div>
          </div>
        } @else {
          <div class="load-more">
            <button class="primary-button" (click)="loadMoreProjects()">
              <span class="material-icons">expand_more</span>
              Load More Projects
            </button>
          </div>
        }
        <div #scrollTrigger class="scroll-trigger"></div>
      } @else {
        <div class="load-finished">
          <div class="checkmark-container">
            <span class="material-icons checkmark">done_all</span>
          </div>
          <h3 class="achievement-title">All Projects Loaded</h3>
          <p class="achievement-subtitle">You've viewed all available projects. Ready to find your next investment?</p>
        </div>
      }
    }
  }
</div>